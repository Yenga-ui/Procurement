@{
    ViewData["Title"] = "Procurement Plans";
}
<!--begin::Page Vendors Styles(used by this page)-->
<link href="~/assets/plugins/custom/datatables/datatables.bundle.css" rel="stylesheet" type="text/css" />
<!--end::Page Vendors Styles-->
<!--begin::Card-->
<!--end::Card-->
<div class="container">
    <div class="row">
       <div class="col-md-12">
           <div class="card text-right border-0">
                <div class="card-toolbar">
            <!--begin::Dropdown-->
            <div class="dropdown dropdown-inline mr-2">
                <button type="button" class="btn btn-light-primary font-weight-bolder dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="la la-download"></i>Export
                </button>

                <!--begin::Dropdown Menu-->
                <div class="dropdown-menu dropdown-menu-sm dropdown-menu-right">
                    <!--begin::Navigation-->
                    <ul class="navi flex-column navi-hover py-2">
                        <li class="navi-header font-weight-bolder text-uppercase font-size-sm text-primary pb-2">Choose an option:</li>
                        <li class="navi-item">
                            <a href="#" class="navi-link">
                                <span class="navi-icon">
                                    <i class="la la-print"></i>
                                </span>
                                <span class="navi-text">Print</span>
                            </a>
                        </li>
                        <li class="navi-item">
                            <a href="#" class="navi-link">
                                <span class="navi-icon">
                                    <i class="la la-copy"></i>
                                </span>
                                <span class="navi-text">Copy</span>
                            </a>
                        </li>
                        <li class="navi-item">
                            <a href="#" class="navi-link">
                                <span class="navi-icon">
                                    <i class="la la-file-excel-o"></i>
                                </span>
                                <span class="navi-text">Excel</span>
                            </a>
                        </li>
                        <li class="navi-item">
                            <a href="#" class="navi-link">
                                <span class="navi-icon">
                                    <i class="la la-file-text-o"></i>
                                </span>
                                <span class="navi-text">CSV</span>
                            </a>
                        </li>
                        <li class="navi-item">
                            <a href="#" class="navi-link">
                                <span class="navi-icon">
                                    <i class="la la-file-pdf-o"></i>
                                </span>
                                <span class="navi-text">PDF</span>
                            </a>
                        </li>
                    </ul>
                    <!--end::Navigation-->
                </div>
                <!--end::Dropdown Menu-->
            </div>
            <!--end::Dropdown-->

            <button data-toggle="modal"
                    type="button"
                    data-target="#bulkUploadProcurementPlanModal"
                    class="btn btn-light-primary font-weight-bolder mr-2">
                <i class="la la-upload"></i>Bulk Upload
            </button>
        </div>
           </div>
       </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="card card-custom gutter-b example example-compact col-xs-6">
                <div class="card-header" style="background-color:bisque">
                    <h3 class="card-title">Procurement Plan</h3>
                    <div class="card-toolbar">
                        <div class="example-tools justify-content-center">
                            <span class="example-toggle" data-toggle="tooltip" title="View code"></span>
                            <span class="example-copy" data-toggle="tooltip" title="Copy code"></span>
                        </div>
                    </div>
                </div>

                <!--begin::Form-->
                <form id="planHeaderForm" method="post">
                    <div class="card-body">
                        <div class="form-group mb-8">
                            <div class="alert alert-custom alert-default" role="alert">
                                <div class="alert-icon">
                                    <span class="svg-icon svg-icon-primary svg-icon-xl">
                                        <!--begin::Svg Icon | path:assets/media/svg/icons/Tools/Compass.svg-->
                                        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                                            <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                                <rect x="0" y="0" width="24" height="24" />
                                                <path d="M7.07744993,12.3040451 C7.72444571,13.0716094 8.54044565,13.6920474 9.46808594,14.1079953 L5,23 L4.5,18 L7.07744993,12.3040451 Z M14.5865511,14.2597864 C15.5319561,13.9019016 16.375416,13.3366121 17.0614026,12.6194459 L19.5,18 L19,23 L14.5865511,14.2597864 Z M12,3.55271368e-14 C12.8284271,3.53749572e-14 13.5,0.671572875 13.5,1.5 L13.5,4 L10.5,4 L10.5,1.5 C10.5,0.671572875 11.1715729,3.56793164e-14 12,3.55271368e-14 Z" fill="#000000" opacity="0.3" />
                                                <path d="M12,10 C13.1045695,10 14,9.1045695 14,8 C14,6.8954305 13.1045695,6 12,6 C10.8954305,6 10,6.8954305 10,8 C10,9.1045695 10.8954305,10 12,10 Z M12,13 C9.23857625,13 7,10.7614237 7,8 C7,5.23857625 9.23857625,3 12,3 C14.7614237,3 17,5.23857625 17,8 C17,10.7614237 14.7614237,13 12,13 Z" fill="#000000" fill-rule="nonzero" />
                                            </g>
                                        </svg>
                                        <!--end::Svg Icon-->
                                    </span>
                                </div>
                                <div class="alert-text">Create Procurement plan header and then add its associated line items.</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>
                                Procurement Plan
                                <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="title" name="title" placeholder="Enter procurement plan" />
                            <span class="form-text text-muted">Enter a unique procurement plan title.</span>
                        </div>
                        <div class="form-group">
                            <label for="exampleInputPassword1">
                                Description
                                <span class="text-danger">*</span>
                            </label>
                            <textarea type="text" class="form-control" id="description" name="description" placeholder="" rows="3"></textarea>
                        </div>

                        <div class="form-group">
                            <label for="exampleSelect1">
                                Year
                                <span class="text-danger">*</span>
                            </label>
                            <select class="form-control" id="exampleSelect1" name="year">
                                <option>2022</option>
                                <option>2023</option>
                                <option>2024</option>
                                <option>2025</option>
                                <option>2026</option>
                            </select>
                        </div>



                        <!--begin: Code-->
                        <div class="example-code mt-10">
                            <div class="example-highlight">
                                <pre style="height:400px">
                            </div>
                        </div>
                        <!--end: Code-->
                    </div>
                    <div class="card-footer">
                        <button type="submit" class="btn btn-primary mr-2" id="create">Create</button>

                    </div>
                </form>
                <!--end::Form-->

            </div>

        </div>

        <div class="col-md-8">
            <div class="row">
                <div class="card card-custom gutter-b example example-compact col-md-12">

                    <form id="procurementForm">
                        <div class="card-header" >

                            <div class="row">
                                <div class="col-sm-6">
                                    <h3 class="text-muted">ADD PROCUREMENT PLAN ITEMS</h3>
                                </div>
                                <div id="submissionBtn" class="col-sm-6 text-right d-none">
                                    <button type="button" id="proceedBtn" class="btn btn-sm btn-light-success">
                                        <i class="la la-arrow-right"></i>
                                        Submit
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">

                            <p class="mb-3 text-primary font-weight-bolder">Procurement Plan Items</p>
                            <div class="form-group row">
                                <div class="col-lg-4">
                                    <label>Class</label>
                                    <input type="text" class="form-control"
                                           name="Class"
                                           required />
                                </div>
                                <div class="col-lg-4">
                                    <label>UNSPSC</label>
                                    <input type="number"
                                           name="UNSPSC"
                                           class="form-control" />
                                </div>
                                <div class="col-lg-4">
                                    <label>Reference Number</label>
                                    <input type="text" class="form-control"
                                           name="Ref_No"
                                           required />
                                </div>
                            </div>
                            <div class="form-group row">
                                <div class="col-lg-4">
                                    <label>Project Code</label>
                                    <input type="text"
                                           name="Project_Code"
                                           class="form-control" />
                                </div>
                                <div class="col-lg-4">
                                    <label>Unit of Measure</label>
                                    <select name="Unit_of_Measure"
                                            class="form-control selectpicker">
                                        <option>Lot</option>
                                        <option>Each</option>
                                        <option>
                                            <b>Person</b>
                                        </option>
                                    </select>
                                </div>
                                <div class="col-lg-4">
                                    <label>Quantity</label>
                                    <input type="number"
                                           name="Quantity"
                                           class="form-control" />
                                </div>
                            </div>

                            <div class="form-group row">
                                <div class="col-lg-4">
                                    <label>Source of Funds</label>
                                    <input type="text" name="Source_of_Funds" class="form-control" />



                                </div>
                                <div class="col-lg-4">
                                    <label>Prequalification (Y/N)</label>
                                    <input name="Prequalification"
                                           type="text" class="form-control" />
                                </div>
                                <div class="col-lg-4">
                                    <label>Procurement Method</label>
                                    <select name="Procurement_Method" class="form-control" id="procMethod">
                                        <option>sb</option>
                                        <option>db</option>
                                        <option>
                                            <b>lbn</b>
                                        </option>
                                        <option>lsn</option>
                                    </select>
                                </div>
                            </div>
                            <p class="mb-3 text-primary font-weight-bolder">Estimated Dates</p>
                            <div class="form-group row">
                                <div class="col-lg-4">
                                    <label>Publication</label>
                                    <div class="input-group">
                                        <input type="text" id="publication"
                                               class="form-control kt_datepicker"
                                               name="Publication"
                                               placeholder="Select date" />
                                        <div class="input-group-append">
                                            <span class="input-group-text">
                                                <i class="la la-calendar-check-o"></i>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-4">
                                    <label>Award</label>
                                    <div class="input-group">
                                        <input type="text"
                                               class="form-control kt_datepicker" id="award"
                                               name="Award"
                                               placeholder="Select date" />
                                        <div class="input-group-append">
                                            <span class="input-group-text">
                                                <i class="la la-calendar-check-o"></i>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-4">
                                    <label>Start</label>
                                    <div class="input-group">
                                        <input type="text"
                                               class="form-control kt_datepicker" id="start"
                                               name="Start"
                                               placeholder="Select date" />
                                        <div class="input-group-append">
                                            <span class="input-group-text">
                                                <i class="la la-calendar-check-o"></i>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group row">

                                <div class="col-lg-4">
                                    <label>Description</label>
                                    <textarea name="Description"
                                              class="form-control"
                                              style="height: 100px;"></textarea>
                                </div>
                                <div class="col-lg-4">
                                    <label>Comments</label>
                                    <textarea name="Comments"
                                              class="form-control"
                                              style="height: 100px;"></textarea>
                                </div>
                                <div class="col-lg-4">
                                    <label>Type of Entry</label>
                                    <input type="text"
                                           name="Type_of_Entry"
                                           class="form-control" required />
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-4">
                                    <label>Budget</label>
                                    <input type="number"
                                           name="budget"
                                           class="form-control" required />

                                </div>
                                <div class="col-lg-8 text-right">
                                    <button type="button" id="saveData" class="btn btn-primary" disabled>Add</button>

                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="row d-none" id="addedItemsContent">
        <div class="card card-custom gutter-b example example-compact  table-responsive">
            <table class="table table-bordered table-hover table-checkable mt-10" id="kt_datatable">
                <thead>
                    <tr>
                        <th>Class</th>
                        <th>UNSPSC</th>
                        <th>Description</th>
                        <th>Ref No.</th>
                        <th>Project Code</th>
                        <th>Unit of Measure</th>
                        <th>Quantity</th>
                        <th>Source of funds</th>
                        <th>Prequalification</th>
                        <th>Procurement Method</th>
                        <th>Publication</th>
                        <th>Award</th>
                        <th>Start</th>
                        <th>Type Of Entry</th>
                        <th>Budget</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <!--end: Datatable-->
        </div>
    </div>
</div>

<!--end::Content-->
<!-- Modal Here-->
<partial name="_ProcurementPlanForm.cshtml" />
@section Scripts{
<!--begin::Page Vendors(used by this page)-->
@*<script src="~/assets/plugins/custom/datatables/datatables.bundle.js" asp-append-version="true"></script>
*@<!--begin::Page Vendors(used by this page)-->
<script src="~/assets/plugins/dataTables/jquery.dataTables.js" asp-append-version="true"></script>
<!--end::Page Vendors-->
<!--begin::Page Scripts(used by this page)-->
@*<script src="~/assets/js/pages/crud/datatables/basic/headers.js" asp-append-version="true"></script>
*@<!--end::Page Scripts-->
<!--begin::Page Scripts(used by this page)-->
<script src="~/assets/js/pages/crud/forms/widgets/bootstrap-select.js"></script>
<!--end::Page Scripts-->
<!--begin::Page Scripts(used by this page)-->
<script src="~/js/file-upload/procurementplan.dropzonejs.js" asp-append-version="true"></script>
<!--end::Page Scripts-->
<!--begin::Page Scripts(used by this page)-->
<script src="~/assets/js/pages/crud/forms/validation/form-widgets.js" asp-append-version="true"></script>
<!--end::Page Scripts-->

<script>
    var table = "";
    $(document).ready(function(){

        table = $('#kt_datatable').DataTable({
            responsive: true,
            "bDestroy": true,
            columnDefs: [
                {
                    targets: -1,
                    title: 'Actions',
                    orderable: false,
                    render: function(data, type, full, meta) {
                        return '\
                            <div class="dropdown dropdown-inline">\
                                <a href="javascript:;" class="btn btn-sm btn-clean btn-icon" data-toggle="dropdown">\
                                    <i class="la la-cog"></i>\
                                </a>\
                                <div class="dropdown-menu dropdown-menu-sm dropdown-menu-right">\
                                    <ul class="nav nav-hoverable flex-column">\
                                        <li class="nav-item"><a class="nav-link" href="#"><i class="nav-icon la la-edit"></i><span class="nav-text">Edit Details</span></a></li>\
                                        <li class="nav-item"><a class="nav-link" href="#"><i class="nav-icon la la-leaf"></i><span class="nav-text">Update Status</span></a></li>\
                                        <li class="nav-item"><a class="nav-link" href="#"><i class="nav-icon la la-print"></i><span class="nav-text">Print</span></a></li>\
                                    </ul>\
                                </div>\
                            </div>\
                            <a href="javascript:;" class="btn btn-sm btn-clean btn-icon" title="Edit details">\
                                <i class="la la-edit"></i>\
                            </a>\
                            <a href="javascript:;" class="btn btn-sm btn-clean btn-icon" title="Delete">\
                                <i class="la la-trash"></i>\
                            </a>\
                        ';
                    },
                },
                {
                    width: '75px',
                    targets: 8,
                    render: function(data, type, full, meta) {
                        var status = {
                            1: {'title': 'Pending', 'class': 'label-light-primary'},
                            2: {'title': 'Delivered', 'class': ' label-light-danger'},
                            3: {'title': 'Canceled', 'class': ' label-light-primary'},
                            4: {'title': 'Success', 'class': ' label-light-success'},
                            5: {'title': 'Info', 'class': ' label-light-info'},
                            6: {'title': 'Danger', 'class': ' label-light-danger'},
                            7: {'title': 'Warning', 'class': ' label-light-warning'},
                        };
                        if (typeof status[data] === 'undefined') {
                            return data;
                        }
                        return '<span class="label label-lg font-weight-bold' + status[data].class + ' label-inline">' + status[data].title + '</span>';
                    },
                },
                {
                    width: '75px',
                    targets: 9,
                    render: function(data, type, full, meta) {
                        var status = {
                            1: {'title': 'Online', 'state': 'danger'},
                            2: {'title': 'Retail', 'state': 'primary'},
                            3: {'title': 'Direct', 'state': 'success'},
                        };
                        if (typeof status[data] === 'undefined') {
                            return data;
                        }
                        return '<span class="label label-' + status[data].state + ' label-dot mr-2"></span>' +
                            '<span class="font-weight-bold text-' + status[data].state + '">' + status[data].title + '</span>';
                    },
                },
            ],
        });
        $("#procMethod").empty();
        $.ajax({
url: "tenderTechnique",
type: "GET",
contentType: "application/json; charset=utf-8",
datatype: JSON,
success: function (result) {
    console.log(result.payload);
$(result.payload).each(function () {
$("#procMethod").append($("<option></option>").val(this.method).html(this.method));
});
},
error: function (data) { }
});

        $("#start").on('change',function(e){



        });
         
         $("#award").on('change',function(e){

             
       

        });
          $("#publication").on('change',function(e){


          var startTime = new Date( $("#publication").val());
          var endTime = new Date($("#award").val());

        });
        

        $("form#planHeaderForm").on('submit', function(e){
           e.preventDefault();
           e.stopPropagation();

           let formData = new FormData($("#planHeaderForm")[0]);
           let payload = {};
           for(var pair of formData.entries()) {
                payload[pair[0]]= pair[1];
           }

           let settings = {
              url: "ProcHeader",
              method: "POST",
              dataType: "json",
              data: JSON.stringify(payload),
              contentType: 'application/json'
           };
           $.ajax(settings)
           .done(function(response){
               if(response.success){
               $("#saveData").removeAttr('disabled');
               $('#title').attr('readonly', 'true');
               $('#exampleSelect1').prop('disabled',true);
               $('#description').attr('readonly', 'true');
               $('#year').attr('readonly', 'true');
               $('#create').prop('disabled', 'true');
               }else{
                   swal.fire('Error','Failed to save Data','error');
               }

           }).fail(function(xhr){
               swal.fire('Error','Failed to save Data','error');
           });
       });

       $("#saveData").on('click', function(){

           console.log('Clicked')

           let formData = new FormData($("#procurementForm")[0]);
           let payload = {};
           for(var pair of formData.entries()) {
                payload[pair[0]]= pair[1];
           }

           let settings = {
              url: "procurement-plan/create",
              method: "POST",
              dataType: "json",
              data: JSON.stringify(payload),
              contentType: 'application/json'
           };
           $.ajax(settings)
           .done(function(response){

               if(response.success){

                   let data = response.payload;

                   if($("#addedItemsContent").hasClass('d-none'))
                   {
                       $("#addedItemsContent").removeClass('d-none');
                       $("#submissionBtn").removeClass('d-none');
                   }

                   let row = `<tr>
                        <td>${data.class}</td>
                        <td>${data.Unspsc}</td>
                        <td>${data.description}</td>
                        <td>${data.refNo}</td>
                        <td>${data.projectCode}</td>
                        <td>${data.unitofmeasure}</td>
                        <td>${data.quantity}</td>
                        <td>${data.sourceOfFunds}</td>
                        <td>${data.prequalification}</td>
                        <td>${data.procurementMethod}</td>
                        <td>${data.publication}</td>
                        <td>${data.award}</td>
                        <td>${data.start}</td>
                        <td>${data.typeofentry}</td>
                        <td>${data.budget}</td>
                        <td>
                            <div class="dropdown dropdown-inline">
                                <a href="javascript:;" class="btn btn-sm btn-clean btn-icon" data-toggle="dropdown">
                                    <i class="la la-cog"></i>
                                </a>
                                <div class="dropdown-menu dropdown-menu-sm dropdown-menu-right">
                                    <ul class="nav nav-hoverable flex-column">
                                        <li class="nav-item"><a class="nav-link" href="#"><i class="nav-icon la la-edit"></i><span class="nav-text">Edit Details</span></a></li>
                                        <li class="nav-item"><a class="nav-link" href="#"><i class="nav-icon la la-leaf"></i><span class="nav-text">Update Status</span></a></li>
                                        <li class="nav-item"><a class="nav-link" href="#"><i class="nav-icon la la-print"></i><span class="nav-text">Print</span></a></li>
                                    </ul>
                                </div>
                            </div>
                            <a href="javascript:;" class="btn btn-sm btn-clean btn-icon" title="Edit details">
                                <i class="la la-edit"></i>
                            </a>
                            <a href="javascript:;" class="btn btn-sm btn-clean btn-icon" title="Delete">
                                <i class="la la-trash"></i>
                            </a>
                        </td>
                    </tr>`;

                    $('#kt_datatable > tbody').append(row);
                       $('#procurementForm').trigger("reset");
               }else{
                   swal.fire('Error','Could not save Item','error');
               }

           }).fail(function(xhr){
           });
       });

       $("#proceedBtn").on('click', function(){
           window.location.href="/"
       })
    });
</script>

            }
